# 计算机启动

## 内存状态

* 0x0-1MB：
  * 0x0-640KB：空闲空间
    * 0x0-0x7c00：BIOS数据
    * 0x7c00：加载程序起始地址
  * 641KB-1MB：BIOS固件
* 1MB-4GB：空闲空间

* 0x7C00的由来
  * 最开始DOS操作系统至少为32KB，0x0000～0x7FFF（详情看计算机组成原理）
  * 中断处理程序：0x0000～0x03FF
  * 为了把尽量多的连续内存留给操作系统，主引导记录就被放到了内存地址的尾部
  * 一个扇区大小为512字节
  * 主引导记录本身也会产生数据，需要另外留出512字节保存
  * 0x7FFF-512-512+1 = 0x7C00

## BIOS

* 将磁盘的引导扇区（512字节）加载到内存地址0x7C00
* 跳转到CS:IP=0000:7C00

## 加载程序

* 将操作系统代码和数据加载到内存
* 跳转到操作系统的起始地址

## 计算机启动过程

* BIOS：CPU加电，BIOS初始化硬件
  * cpu加电稳定后，读取0xFFFF0处读取第一条指令
  * CS：IP = F000：FFF0（16位实模式，寻找方式为 PC = CS*16 + IP）
  * 第一条指令为跳转指令
  * 只能是1MB的寻址空间
    * CS和IP为16位寄存器
    * CS左移4位加上IP为20位
  * 硬件自检POST(Power On Self Test,上电自检)
  * 内存和显卡等关键部件存在和工作状态
  * 查找执行显卡等接口卡BIOS，进行设备初始化
  * 执行系统BIOS，进行系统检测（光驱或者U盘等即插即用设备）
  * 更新CMOS（Complementary Metal Oxide Semiconductor）特殊RAM中的扩展系统配置数据ESCD（Extended System Configuration Data）
  * 按照指定顺序启动系统

* 主引导记录（MBR）：BIOS读取主引导扇区代码，这是针对于有多个操作系统的计算机（但是在WeTreeOS（以miaos下简称WTOS）中，只有一个引导扇区）
  * 启动代码：446字节
    * 检查分区表正确性
    * 加载并跳转到磁盘上的引导程序
  * 硬盘分区表：64字节
    * 描述分区状态和位置
    * 每个分区的大小为16字节
  * MBR结束标志字：2字节
    * 0x55
    * 0xAA
  * 总共512字节

* 活动分区：主引导扇区代码读取活动分区的引导扇区代码
  * 跳转指令：跳转到启动代码（与平台相关）
  * 文件卷头：文件系统描述信息
  * 启动代码：跳转到加载程序
  * 结束标志：0x55，0xAA

* 加载程序（bootloader）：引导扇区读取文件系统的加载程序
  * 从文件系统中读取启动配置信息
  * 启动菜单，可选操作系统内核和加载参数
  * 依靠配置，加载内核，并跳到内核执行处

## 系统启动规范

* BIOS：
  * 固化到主板的程序
  * 系统设置，自检程序，系统自启动程序
  * BIOS-MBR（最多4个系统）、BIOS-GPT（超过4个系统）、PXE（网络启动）
* UEFI：
  * 接口标准
  * 所有平台上一致的操作系统启动服务
