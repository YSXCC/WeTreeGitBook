# 实模式和保护模式

## 实模式

* 实模式出现于早期8088CPU时期。当时由于CPU的性能有限，一共只有20位地址线。所以最大寻址空间为1MB。

* 寻址方式：物理地址 = 段基址<<4 + 段内偏移

## 保护模式

* 从80386开始，进入32位cpu时代，有32位地址总线。

* 地址并没有用寄存器直接指定，仍然采用了“段+偏移”的模式

* 实模式下面段的大小是固定的64k，而保护模式则不是固定的。

* 寻址方式
  * 16位寄存器中存放的是一个索引，这个索引指向的是一个数据结构的一个表项
  * 表项中详细地定义了段的起始地址、界限、属性等信息
  * 该表项被称为GDT（全局描述符表），也可以是LDT（局部描述符表）
  * 在 32 位保护模式下，段地址是 32 位的线性地址，如果未开启分页功能，该线性地址就是物理地址。即段地址 = 段基址 + 偏移地址。
  * GDT中的表项也有一个专门的名字，叫做描述符（Descriptor）

| BYTE7 | BYTE6 | BYTE5 | BYTE4 | BYTE3 | BYTE2 | BYTE1 | BYTE0 |
| ------| :--:  | :--:  | -----| ------ | ------| ------| ------|
| 段基址3| 属性值 | 属性值 |段基址2| 段基址1|段基址1 | 段界限1| 段界限1|
| 31~24 | xxxx  | xxxx  |23~16  | 15~8  |  7~0  | 15~8  |  7~0  |

* BYTE5:attribute flags #1

  * 0~3:TYPE
    * 数据段：
      * 0:A(Accessed)
      * 1:W(Write)
      * 2:E(Extend)
      * 3:X(eXecutable)
    * 代码段：
      * 0:A
      * 1:R(Read)
      * 2:C(Conforming)
      * 3:X
  * 4:S

  * 5~6:DPL

  * 7:P

* BYTE6:

  * 0~3:段界限2（16~19）

  * 4~7:attribute flags #2

    * 4:AVL

    * 5:Reserved

    * 6:D/B

    * 7:G

* 段基址：规定的线性地址空间中段的起始地址。在80386保护模式下，段基地址长32位。因为基地址长度与寻址地址的长度相同，所以任何一个段都可以从32位线性地址空间中的任何一个字节开始，而不像实方式下规定的边界必须被16整除。

* 段界限：规定段的大小。在80386保护模式下，段界限用20位表示，而且段界限可以是以字节为单位或以4K字节为单位。（通过对attribute设置来达到切换）

* 段属性：（attribute flags）
  * 类型（TYPE）: 用于区别不同类型的描述符。可表示所描述的段是代码段还是数据段，所描述的段是否可读/写/执行，段的扩展方向等。
    * 数据段：
      * 0:A(Accessed)：表示指向的段是否被访问过，创建时为0
      * 1:W(Write)：0表示只读，1表示可写
      * 2:E(Extend)：0表示向上拓展，向高地址拓展，表示普通的数据段；1表示向下拓展，表示堆栈段。
      * 3:X(eXecutable)：0表示不可执行，1表示可以执行（数据段总是不可以执行的，可能这就是区别的方式吧）
    * 代码段：
      * 0:A
      * 1:R(Read)：0表示不可读，1表示可读
      * 2:C(Conforming)：特权级依从；
        * 0表示非依从代码段，这样的代码可以和与他特权级相同的代码段调用，或者通过门调用；
        * 1表示允许从低特权级的程序转移到该段执行
      * 3:X：0表示不可执行，1表示可以执行（数据段总是不可以执行的，可能这就是区别的方式吧）

  ![描述符TYPE](https://gitee.com/YSXCC/MDImage/raw/master/img/20200210153405.png)

  * 描述符类型标志S（Descriptor type flag）：用于指明一个段描述符是系统段描述符（当S=0）还是代码或数据段描述符（当S=1）。

  * 描述符特权级DPL（Descriptor Privilege Level ）：用来实现保护机制特权级范围从0到3。0级特权级最高，3级最低。DPL用于控制对段的访问。

  * 段存在标志P（Segment present）：用于指出一个段是在内存中（P=1）还是不在内存中（P=0）。

  * 可用位AVL（Available bits）：未使用，可供系统软件使用（unused, available for operating system）

  * 保留位（Reserved bits）:应该总是设置为0。

  * 默认操作大小/默认栈指针大小和/或上界限 D/B（Default operation size/default stack pointer size and/or upper bound）：根据段描述符描述的是一个可执行代码段、下扩数据段还是一个堆栈段，这个标志具有不同的功能。（对于32位代码和数据段，这个标志应该总是设置为1；对于16位代码和数据段，这个标志被设置为0。）

    * 可执行代码段：D标志。指出该段中的指令引用有效地址和操作数的默认长度。如果该标志置位，则默认值是32位地址和32位或8位的操作数；如果该标志为0，则默认值是16位地址和16位或8位的操作数。

    * 栈段：B标志。指明隐含堆栈操作（如PUSH、POP或CALL）时的栈指针大小。如果该标志置位，则使用32位栈指针并存放在ESP寄存器中；如果该标志为0，则使用16位栈指针并存放在SP寄存器中。如果堆栈段被设置成一个下扩数据段，这个B标志也同时指定了堆栈段的上界限。

    * 下扩数据段：此时该标志称为B标志，用于指明堆栈段的上界限。如果设置了该标志，则堆栈段的上界限是0xFFFFFFFF（4GB）；如果没有设置该标志，则堆栈段的上界限是0xFFFF（64KB）。

  * 颗粒度标志G（Granularity）：该字段用于确定段限长字段Limit值的单位。G=0表示段界限以字节位为单位，20位的界限可表示的范围是1字节至1M字节，增量为1字节；G=1表示段界限以4K字节为单位，于是20位的界限可表示的范围是4K字节至4G字节，增量为4K字节。

* 段选择子

| 15~3 |   2  | 1~0  |
| :--: | :--: | :--: |
| 索引值|  TI  | RPL  |

* 索引值（Index）：给出了描述符在GDT或LDT中的索引项号
* 表指示标志TI（Table Index）：TI=0 描述符在GDT中,TI＝1 描述符在LDT
* 请求特权级RPL(Requested Privilege Level)：0，1，2，3四个特权级

详情请见

* [百度百科——段描述符](https://baike.baidu.com/item/%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6/9036846)

* [维基百科——x86内存分段](https://zh.wikipedia.org/wiki/X86%E8%A8%98%E6%86%B6%E9%AB%94%E5%8D%80%E6%AE%B5)

* [博客园——段选择子与描述符](https://www.cnblogs.com/fxcser/articles/1882080.html)
