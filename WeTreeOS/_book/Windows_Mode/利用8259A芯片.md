# 利用8259A芯片

## 中断发送机制

* 在个人计算机中，用得最多的中断代理就是 8259 芯片，它就是通常所说的中
断控制器，从 8086 处理器开始，它就一直提供着这种服务。即使是现在，在绝大多数单处理器的 计算机中，也依然有它的存在。

![8259A内部信息](https://gitee.com/YSXCC/MDImage/raw/master/img/20200212165659.png)

* Intel 处理器允许 256 个中断，中断号的范围是 0～255，8259 负责提供其中的 15 个，但中断号并不固定。之所以不固定，是因为当初设计的时候，允许软件根据自己的需要灵活设置中断号，以防止发生冲突。

* 该中断控制器芯片有自己的端口号，可以像访问其他外部设备一样用 in 和 out 指令 来改变它的状态，包括各引脚的中断号。正是因为这样，它又叫可编程中断控制器（Programmable Interrupt Controller，PIC）。

![8259A芯片](https://gitee.com/YSXCC/MDImage/raw/master/img/20200212154435.png)

* 主片：地址0x20~0x3F
  * IR0：系统定时器/计数器（时钟）
  * IR1：键盘
  * IR2：级联从片
  * IR3：串口2
  * IR4：串口1
  * IR5：并口2
  * IR6：软盘
  * IR7：并口1

* 从片：地址0xA0~0xBF
  * IR0：实时时钟（RTC）
  * IR1：INT0AH
  * IR2：保留
  * IR3：保留
  * IR4：PS2鼠标
  * IR5：协处理器
  * IR6：硬盘
  * IR7：保留

![实时时钟（RTC）](https://gitee.com/YSXCC/MDImage/raw/master/img/20200212165508.png)

硬件初始化：规定顺序，不能修改（关于’和‘和‘或’的问题，就是具体情况具体初始化。详情见代码）

  1. 往端口20h（主片）和A0h（从片)发送ICW1
  2. 往端口21h（主片）和A1h（从片)发送ICW2
  3. 往端口21h（主片）和A1h（从片)发送ICW3
  4. 往端口20h（主片）和A0h（从片)发送ICW4

![主片操纵端口详解](https://gitee.com/YSXCC/MDImage/raw/master/img/20200212213720.png)

![从片操纵端口详解](https://gitee.com/YSXCC/MDImage/raw/master/img/20200212213856.png)

* ICW1：
  * 0（IC4）：设置是否发送ICW4。0表示不需要发送，1表示需要发送
  * 1（SNGL）：设置是否级联。0表示级联8259，1表示单个8259
  * 2（ADI）：设置字节数。0表示8字节中断向量，1表示4字节中断向量（对8086和8088无用）
  * 3（LTIM）：设置中断形式。0表示边沿触发，1表示水平触发
  * 4：必须为1
  * 5~7：必须为0（对8086和8088无用）

* ICW2：
  * 0~2：对于80X86架构必须设置为0
  * 3~7：80X86中断向量
  * Linux-0.11 系统把主片的 ICW2 设置为 0x20，表示主片中断请求0~7级对应的中断号是 0x20~0x27；把从片的 ICW2 设置成 0x28，表示从片中断请求8~15级对应的中断号是 0x28~0x2f
  
* ICW3（主片）：
  * 0：0无从片，设置为1，IR0级联
  * 1：0无从片，设置为1，IR1级联
  * 2：0无从片，设置为1，IR2级联
  * 3：0无从片，设置为1，IR3级联
  * 4：0无从片，设置为1，IR4级联
  * 5：0无从片，设置为1，IR5级联
  * 6：0无从片，设置为1，IR6级联
  * 7：0无从片，设置为1，IR7级联

* ICW3（从片）：
  * 0~2：从片级联主片的IR号
  * 3~7：必须为0

* 对ICW3补充：Linux-0.11 内核把8259A主片的 ICW3 设置为 0x04，即 S2=1，其余各位为0。表示主芯片的 IR2 引脚连接一个从芯片。从芯片的 ICW3 被设置为 0x02，即其标识号为2。表示此从片连接到主片的IR2引脚。 因此，中断优先级的排列次序为：0级最高，1级次之，接下来是从片上的 8~15 级，最后是主片的 3~7 级。

* ICW4：
  * 0：0表示MCS 80/85模式，1表示x86模式
  * 1（AEOI）：0表示正常EOI，1表示自动EOI
  * 2~3：主从缓冲模式
    * 2（M/S）：0表示缓存方式下从片，1表示缓存方式下主片
    * 3（BUF）：0表示非缓存方式，1表示缓冲方式
  * 4：0表示sequential模式，1表示SFNM模式
    * 4->0：普通全嵌套
    * 4->1：特殊全嵌套
  * 5~7：必须为0

硬件运行过程中的监控和改变：在 8259A 工作期间，我们也可以利用操作命令字 OCW1~OCW3 来监测 8259A 的工作状况，或者随时改变初始化时设定的 8259A 的工作方式。

* OCW1：

若 Mi=1，则屏蔽对应中断请求级IRi；若 Mi=0，则允许IRi. 另外，屏蔽高优先级并不会影响其他低优先级的中断请求。

![OCW1](https://gitee.com/YSXCC/MDImage/raw/master/img/20200212163606.png)

* OCW2：

|位|名称|含义|
|:--:|:--:| :--:|
|7|R|中断优先级是否按循环方式设置。R＝1表示采用循环方式，R＝0表示采用非循环方式。 |
|6|SL|OCW2中的L2~L0是否有效。SL＝1表示有效，SL＝0表示无效。|
|5|EOI|中断结束命令位。EOI＝1使当前ISR寄存器的相应位清0。当ICW4中的AEOI为0时，ISR中的相应置位就要由该命令位来清除。|
|4-3|——|必须为00，00是OCW2的标识位。|
|2-0|L2-L0|在SL=1时配合R、SL、EOI的设置，用来确定一个中断优先级的编码。L2、L1、L0 的8种编码000～111分别与IR0～IR7相对应。|

* OCW2 Commands：

|R|SL|EOI|优先级管理方式|中断结束方式|
|:--:|:--:|:--:|:--:|:--:|
|0|0|1|固定优先级|一般EOI|
|0|1|1|固定优先级|特殊EOI ，ISR(L2~L0)复位。|
|1|0|1|自动循环|一般EOI|
|1|0|0|设置自动循环方式（在AEOI模式下）|——|
|0|0|0|清除自动循环方式（在AEOI模式下）|——|
|1|1|0|设置优先级命令|——|
|1|1|1|特殊循环，置IR(L2~L0)优先级为最低|特殊EOI ，ISR(L2~L0)复位。|
|0|1|0|——|——|

* OCW3：

|位|名称|含义|
|:--:|:--:| :--:|
|7|——|恒为0|
|6|ESMM|SMM使能位。 ESMM=0，SMM的值不起用；ESMM=1，由SMM位决定是否工作在特殊屏蔽方式。|
|5|SMM|ESMM=1，SMM=0时，复位特殊屏蔽（表示8259A不是工作在特殊屏蔽方式）；ESMM=SMM=1，设置特殊屏蔽。|
|4-3|——|恒为01，是OCW3的特征位|
|2|P|查询命令(Poll Command)标识位。P=1，查询；P=0，不查询。|
|1~0|RR，RIS|RR（read register command）=1，表示读ISR或IRR。RR＝1，RIS＝0时，读取IRR；RR＝1，RIS＝1时，读取ISR。|
