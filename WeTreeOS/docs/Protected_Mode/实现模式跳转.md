# 实现模式跳转

## 实模式vs保护模式

32位保护模式相对于16位实模式来说，不同点有：

* 寄存器宽度从16位扩展到32位（但是为了兼容之前处理器，比如AX在EAX的低16位）

* 增加了几个通用段寄存器，FS和GS
  * FS:标志段寄存器
  * GS:全局段寄存器

* 内存地址扩展到32位，能够寻址4G内存空间

* 内存管理方面：
  * 代码有权限，能够设置ring 0-3四种级别
  * CPU实现了虚拟内存技术

## 跳转实现步骤

* 初始化GDT表
* 初始化段选择子
* 初始化各个段描述符
* 用lgdt加载gdtr
* 关中断
  * 实模式和保护模式下的中断不一样
  * 保护模式利用IDT实现中断，而不可直接调用BIOS中断
  * 打开A20地址线
    * 8086中，只有20位地址总线，当访问地址超过1MB就会回卷（wrap），重新从地址零开始寻址
    * 为了向上兼容，所以需要打开A20地址线
* 置cr0的PE位
  * cr0是寄存器，第0位是PE。0表示实模式，1表示保护模式
  * 开机默认是16位模式，也就是实模式下。所以需要置位
* 跳转，进入保护模式
  * 代码是在16位的段，但是目标地址是32位的
  * 为了防止偏移地址较大时被截断。比如0x12345678，截断后就只剩下0x5678,所以用dword
